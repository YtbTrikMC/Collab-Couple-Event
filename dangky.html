<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>COUPLE COLLAB EVENT – Đăng ký Tham Gia</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      background: #f2f2f2;
    }
    h2 {
      text-align: center;
    }
    label {
      margin-top: 10px;
      display: block;
    }
    input, select, button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      font-size: 16px;
    }
    #nav {
      margin-top: 20px;
      text-align: center;
    }
    #nav a {
      margin: 0 10px;
      text-decoration: none;
      color: #007bff;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h2>Đăng ký tham gia sự kiện</h2>

  <form id="registerForm">
    <label for="gmail">Gmail:</label>
    <input type="email" id="gmail" required>

    <label for="facebook">Link Facebook:</label>
    <input type="url" id="facebook" placeholder="https://facebook.com/..." required>

    <label for="nickname">Nickname:</label>
    <input type="text" id="nickname" required>

    <label for="pttt">Phương thức thanh toán:</label>
    <select id="pttt" required onchange="updatePTTT()">
      <option value="">-- Chọn --</option>
      <option value="Bank">Ngân hàng</option>
      <option value="Momo">Momo</option>
      <option value="Nhà mạng">Nhà mạng</option>
    </select>

    <div id="bankFields" style="display:none;">
      <label for="stk">Số tài khoản:</label>
      <input type="text" id="stk">
      <label for="bank">Tên ngân hàng:</label>
      <input type="text" id="bank">
    </div>

    <div id="momoFields" style="display:none;">
      <label for="momoStk">Số Momo:</label>
      <input type="text" id="momoStk">
    </div>

    <div id="carrierFields" style="display:none;">
      <label for="sdt">Số điện thoại:</label>
      <input type="text" id="sdt">
      <label for="nhamang">Nhà mạng:</label>
      <input type="text" id="nhamang">
    </div>

    <button type="submit">Gửi đăng ký</button>
  </form>

  <div id="nav">
    <a href="dangky.html">Trang 2</a>
    <a href="danhsach.html">Trang 3</a>
    <a href="bangthidau.html">Trang 4</a>
    <a href="bangdiem.html">Trang 5</a>
  </div>

  <script>
    const SHEET_API = "https://api.sheetbest.com/sheets/1a1c2a8f-521c-433e-af69-d07c8bf1165f";
    const username = localStorage.getItem("username");

    if (!username) {
      alert("Bạn cần đăng nhập trước!");
      window.location.href = "index.html";
    }

    document.getElementById("registerForm").addEventListener("submit", async function(e) {
      e.preventDefault();
      const gmail = document.getElementById("gmail").value.trim();
      const nickname = document.getElementById("nickname").value.trim();
      const pttt = document.getElementById("pttt").value;
      const facebook = document.getElementById("facebook").value.trim();

      let stk = "", bank = "", momo = "", sdt = "", nhamang = "";

      if (pttt === "Bank") {
        stk = document.getElementById("stk").value.trim();
        bank = document.getElementById("bank").value.trim();
      } else if (pttt === "Momo") {
        stk = document.getElementById("momoStk").value.trim();
      } else if (pttt === "Nhà mạng") {
        sdt = document.getElementById("sdt").value.trim();
        nhamang = document.getElementById("nhamang").value.trim();
      }

      const res = await fetch(SHEET_API);
      const data = await res.json();
      const oldUser = data.find(u => u.Username === username);

      if (!oldUser) return alert("Không tìm thấy tài khoản.");

      const updated = {
        Username: username,
        Password: oldUser.Password || "",
        Gmail: gmail,
        Nickname: nickname,
        PT_TT: pttt,
        STK: stk,
        "Ngân hàng": bank,
        "SĐT": sdt,
        "Nhà mạng": nhamang,
        Facebook: facebook,
        "Trạng thái": "Đã đăng ký",
        "Được duyệt": oldUser["Được duyệt"] || "false",
        Điểm: oldUser["Điểm"] || "0",
        Couple: oldUser["Couple"] || "",
        "Đối thủ": oldUser["Đối thủ"] || "",
        "Thời gian đấu": oldUser["Thời gian đấu"] || ""
      };

      await fetch(SHEET_API + `/Username/${username}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(updated)
      });

      alert("Đăng ký thành công!");
      location.reload();
    });

    function updatePTTT() {
      const value = document.getElementById("pttt").value;
      document.getElementById("bankFields").style.display = value === "Bank" ? "block" : "none";
      document.getElementById("momoFields").style.display = value === "Momo" ? "block" : "none";
      document.getElementById("carrierFields").style.display = value === "Nhà mạng" ? "block" : "none";
    }
  </script>
</body>
</html>
